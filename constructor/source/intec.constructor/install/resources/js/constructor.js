!function(api){var $=api.$;window.constructor=function(){var constructor,system={},utils,model,models;return constructor={},constructor.container=ko.observable(),constructor.settings={},constructor.widgets=function(){var list,models;return models={},models.widget=function(){var model;return model=function(data){var widget=this,code,list;widget.name=ko.computed(function(){return data.name}),widget.author=ko.computed(function(){return data.author}),widget.id=ko.computed(function(){return data.id}),widget.code=ko.computed(function(){return widget.author()+":"+widget.id()}),widget.icon=ko.computed(function(){return data.icon}),widget.handle=function(e,t,n,r){try{code.call(e,t,n,r)}catch(e){console.error('Error when build "'+widget.code()+'" widget.'),console.error(e)}},widget.templates=((list=ko.observableArray([])).add=function(e){var t;return e=api.isObject(e)?e:{},t=new models.template(widget,e),list.push(t),t},list.get=function(e){return list.findOne(function(t,n){if(n.code()===e)return!0})},list),api.each(data.templates,function(e,t){widget.templates.add(t)}),code=eval("(function (model, data, stage, code) {"+data.model+"})")},model}(),models.template=function(){var model,code;return model=function(widget,data){var template=this;template.widget=ko.computed(function(){return widget}),template.code=ko.computed(function(){return data.code}),template.view=ko.computed(function(){return data.view}),template.settings=ko.computed(function(){return data.settings}),template.handle=function(e,t,n,r){try{code.call(e,t,n,r)}catch(e){console.error('Error when build template "'+template.code()+'" of widget "'+widget.code()+'".'),console.error(e)}},code=eval("(function (model, data, stage, code) {"+data.model+"})")},model}(),list=ko.observableArray([]),list.add=function(e){var t;return e=api.isObject(e)?e:{},t=new models.widget(e),list.push(t),t},list.get=function(e){return list.findOne(function(t,n){if(n.code()===e)return!0})},list}(),constructor.load=function(e){var t;return api.each(e.widgets,function(e,t){constructor.widgets.add(t)}),t=api.isObject(e.container)?new constructor.models.container(e.container):new constructor.models.container({type:"absolute",properties:{height:{value:100,measure:"%"},grid:{type:"adaptive"}}}),constructor.container(t),constructor.settings=new constructor.models.settings(e.settings),constructor},constructor.save=function(){var e;return(e={}).container=constructor.container().save(),e.settings=constructor.settings.save(),this.trigger("save",this,e),e},constructor.utils=((utils={}).properties={},utils.properties.build=function(e){var t={};return api.each(e,function(e,n){if(constructor.models.property.custom.is(n))t[e]=n.save();else if(ko.isObservable(n)&&!ko.isComputed(n))t[e]=n();else if(api.isObject(n)){var r=utils.properties.build(n);api.isEmpty(r)||(t[e]=r)}}),t},utils.properties.parse=function(e,t){var n=function(e,t){api.isObject(e)&&api.each(t,function(t,r){constructor.models.property.custom.is(r)?api.isUndefined(e[t])||r.load(e[t]):ko.isObservable(r)&&!ko.isComputed(r)?api.isUndefined(e[t])||r(e[t]):api.isObject(r)&&api.isObject(e[t])&&n(e[t],r)})};n(e,t)},utils),system=function(){var e,t;return(e={}).models=((t={}).locker=function(){var e=this,t=!1;e.lock=function(){t=!0},e.unlock=function(){t=!1},e.isLocked=function(){return t},e.operation=function(t){var n;if(!e.isLocked()&&api.isFunction(t))return e.lock(),n=t(),e.unlock(),n}},t),e}(),constructor.models=(models={},models.settings=((model=function(e){e=api.isObject(e)?e:{},model.trigger("create",this,e),this.text=new models.settings.text(e.text),model.trigger("created",this,e)}).prototype.save=function(){var e;return e=constructor.utils.properties.build(this),model.trigger("save",this,e),e},model.is=function(e){return e instanceof model},api.extend(model,api.ext.events(constructor)),model),models.settings.text=function(){var e;return(e=function(t){var n=this;t=api.isObject(t)?t:{},e.trigger("create",n,t),n.color=ko.observable(t.color),n.uppercase=ko.observable(t.uppercase),n.font=ko.observable(t.font),api.each(["size","lineHeight","letterSpacing"],function(e,r){var o,i;(o=new models.property.measured(null,null,["px","pt","%","em"])).value.type(api.type.float,!0),i=t[r],api.isObject(t[r])&&(o.value(i.value),o.measure(i.measure)),n[r]=o}),e.trigger("created",n,t)}).is=function(t){return t instanceof e},api.extend(e,api.ext.events(constructor)),e}(),models.property={},models.property.measured=function(){var e;return(e=function(t,n,r){var o=this;r=api.isArray(r)?r:[],e.trigger("create",o,t,n,r),r=ko.observableArray(r||[]),o.value=ko.observable(t),o.measure=ko.observable(),o.measure.filter(function(e){r.indexOf(e)<0&&this(null)}),o.measure.subscribe(function(){o.value.valueHasMutated()}),o.measure(n),o.summary=ko.computed(function(){return api.isDeclared(o.value())?o.value()+o.measure():null}),o.measures=ko.computed(function(){return r()}),e.trigger("created",o,t,n,r)}).is=function(t){return t instanceof e},api.extend(e,api.ext.events(constructor)),e}(),models.property.enumerable=function(){var e;return(e=function(t,n,r){var o=this;r=api.toBoolean(r),n=api.isArray(n)?n:[],e.trigger("create",o,t,n,r),n=ko.observableArray(n||[]),o.value=ko.observable(),o.value.subscribe(function(e){null===e?r||n().length>0&&o.value(n()[0]):n.has(e)||o.value(null)}),o.values=ko.computed(function(){return n()}),o.isNull=ko.computed(function(){return r}),o.value(t),e.trigger("created",o,t,n,r)}).is=function(t){return t instanceof e},api.extend(e,api.ext.events(constructor)),e}(),models.property.custom=function(){var e;return(e=function(t){var n;e.trigger("create",this),n=function(e){var n=Array.prototype.slice.call(arguments,1);if(api.isFunction(t[e]))return t[e].apply(this,n)},this.value=n("create"),this.save=function(){return n("save")},this.load=function(e){n("load",e)},e.trigger("created",this)}).is=function(t){return t instanceof e},api.extend(e,api.ext.events(constructor)),e}(),models.container=function(){var e,t={parent:new system.models.locker,element:new system.models.locker,containers:new system.models.locker};return(e=function(n){var r,o,i,a,s,u,c,l,p,d,m=this;n=api.isObject(n)?n:{},e.trigger("create",m,n,t),m.id=ko.observable(n.id),m.code=ko.observable(n.code),m.type=ko.observable(n.type),m.display=ko.observable(n.display),m.order=ko.observable(n.order),m.order.subscribe(function(){m.hasParent()&&m.getParent().containers.order()}),n.condition=api.isObject(n.condition)?n.condition:{},n.condition.type="group",m.condition=new models.condition(n.condition),m.script=ko.observable(n.script),m.parent=(r=t.parent,(o=ko.observable(null)).subscribe(function(t){e.is(t)&&r.operation(function(){t.removeContainer(m)})},null,"beforeChange"),o.subscribe(function(t){e.is(t)&&r.operation(function(){t.addContainer(m)})}),o),m.element=function(e){var t;return(t=ko.observable(null)).subscribe(function(t){(models.component.is(t)||models.widget.is(t)||models.block.is(t)||models.variator.is(t)||models.area.is(t))&&e.operation(function(){t.setParent(null)})},null,"beforeChange"),t.subscribe(function(t){(models.component.is(t)||models.widget.is(t)||models.block.is(t)||models.variator.is(t)||models.area.is(t))&&e.operation(function(){t.setParent(m)})}),t}(t.element),m.containers=function(t){var n;return(n=ko.observableArray([])).each=function(t,n){var r;api.isFunction(t)&&(api.isUndefined(n)&&(n=!1),(r=function(o){if(o.hasElement()&&n){if(o.hasArea()){var i=o.getArea().container();e.is(i)&&(t.call(i),r(i))}else if(o.hasVariator()){var a=o.getVariator().getVariants();api.each(a,function(n,o){var i=o.container();e.is(i)&&(t.call(i),r(i))})}}else api.each(o.containers(),function(e,o){t.call(o),n&&r(o)})})(m))},n.subscribe(function(r){api.each(r,function(n,r){"added"===r.status&&e.is(r.value)&&t.operation(function(){r.value.setParent(m)}),"deleted"===r.status&&e.is(r.value)&&t.operation(function(){r.value.setParent(null)})}),n.order()},null,"arrayChange"),n.order=function(){t.operation(function(){n.sort(function(e,t){return e.order()==t.order()?0:e.order()<t.order()?-1:1}),api.each(n(),function(e,t){t.order(e)}),n.valueHasMutated()})},n}(t.containers),m.properties=(l=["top","right","bottom","left"],p=["width","height"],d=["x","y"],(i={}).position=ko.computed(function(){switch(m.getParentType()){case"absolute":case"gridded":return"absolute";default:return"relative"}}),i.id=ko.observable(),i.class=ko.observable(""),i.float=ko.observable(),i.text=new models.settings.text,a=["px","%"],s={},u={},api.each(l,function(e,t){var n;(n=new models.property.measured(null,null,a)).value.type(api.type.float,!0),n.bind=ko.computed(function(){return!api.isNull(n.value())}),n.switch=function(){this.value(null!=this.value()?null:0)},i[t]=n}),api.each(p,function(e,t){i[t]=new models.property.measured(null,null,a),i[t].value.type(api.type.float,!0),i[t].min=new models.property.measured(null,null,a),i[t].min.value.type(api.type.float,!0),i[t].max=new models.property.measured(null,null,a),i[t].max.value.type(api.type.float,!0)}),s.horizontal=ko.computed(function(){return i.left.bind()&&i.right.bind()}),s.vertical=ko.computed(function(){return i.top.bind()&&i.bottom.bind()}),u.horizontal=function(){s.horizontal()&&i.height.value(null)},u.vertical=function(){s.vertical()&&i.width.value(null)},i.top.value.subscribe(u.vertical),i.right.value.subscribe(u.horizontal),i.bottom.value.subscribe(u.vertical),i.left.value.subscribe(u.horizontal),i.width.value.subscribe(function(e){!api.isNull(e)&&s.horizontal()&&i.width.value(null)}),i.height.value.subscribe(function(e){!api.isNull(e)&&s.vertical()&&i.height.value(null)}),i.bind=s,i.margin=function(){var e,t=["px","%"];return(e=new models.property.measured(null,null,t)).value.type(api.type.float,!0),e.isAuto=ko.observable(0),e.calculated=ko.computed(function(){return e.isAuto()?"auto":e.summary()}),api.each(l,function(n,r){var o;(o=new models.property.measured(null,null,t)).value.type(api.type.float,!0),o.isAuto=ko.observable(0),o.calculated=ko.computed(function(){var t=o.summary();return o.isAuto()?"auto":(api.isNull(t)&&(t=e.calculated()),t)}),e[r]=o}),e}(),i.padding=function(){var e,t=["px","%"];return(e=new models.property.measured(null,null,t)).value.type(api.type.float,!0),api.each(l,function(n,r){var o;(o=new models.property.measured(null,null,t)).value.type(api.type.float,!0),o.calculated=ko.computed(function(){var t=o.summary();return api.isNull(t)&&(t=e.summary()),t}),e[r]=o}),e}(),i.grid=((c={}).correct={},api.each(p,function(e,t){c.correct[t]=ko.observable(1)}),c.type=ko.observable("none"),c.x=ko.observable(12),c.x.type(api.type.integer,!1),c.y=ko.observable(12),c.y.type(api.type.integer,!1),c.width=ko.observable(24),c.width.type(api.type.integer,!1),c.height=ko.observable(24),c.height.type(api.type.integer,!1),c),i.background=function(){var e,t=["px","cm","em","%"],n=function(e,t){var n=e.summary(),r=t.summary();return api.isNull(n)&&api.isNull(r)?null:(api.isNull(n)&&(n=0),api.isNull(r)&&(r=0),n.toString()+" "+r.toString())};return(e={}).color=ko.observable(),e.image={},e.image.url=ko.observable(),e.repeat=ko.observable(),e.size=function(){var e;return(e={}).type=ko.observable(),e.width=new models.property.measured(null,null,t),e.width.value.type(api.type.float,!0),e.height=new models.property.measured(null,null,t),e.height.value.type(api.type.float,!0),e.calculated=ko.computed(function(){return n(e.width,e.height)}),e}(),e.position=function(){var e;return(e={}).top=new models.property.measured(null,null,t),e.top.value.type(api.type.float,!0),e.left=new models.property.measured(null,null,t),e.left.value.type(api.type.float,!0),e.calculated=ko.computed(function(){return n(e.left,e.top)}),e}(),e}(),i.border=function(){var e;return(e={}).style=ko.observable(),e.color=ko.observable(),e.width=new models.property.measured(null,null,["px","em","cm"]),e.width.value.type(api.type.float,!0),e.radius=new constructor.models.property.measured(null,null,["px","%"]),e.radius.value.type(api.type.float,!0),api.each(l,function(t,n){var r;(r={}).style={},r.style.value=ko.observable(),r.style.calculated=ko.computed(function(){var t=r.style.value();return api.isEmpty(t)&&(t=e.style()),t}),r.color={},r.color.value=ko.observable(),r.color.calculated=ko.computed(function(){var t=r.color.value();return api.isEmpty(t)&&(t=e.color()),t}),r.width=new models.property.measured(null,null,["px","em","cm"]),r.width.value.type(api.type.float,!0),r.width.calculated=ko.computed(function(){var t=r.style.calculated(),n=r.width.summary();return(api.isEmpty(t)||"none"===t)&&(n=0),api.isNull(n)&&(n=e.width.summary()),n}),r.radius=new models.property.measured(null,null,["px","%"]),r.radius.value.type(api.type.float,!0),r.radius.calculated=ko.computed(function(){var t=r.radius.summary();return api.isNull(t)&&(t=e.radius.summary()),t}),e[n]=r}),e}(),i.overflow=function(){var e;return(e={}).value=ko.observable(),api.each(d,function(t,n){var r;(r={}).value=ko.observable(),r.calculated=ko.computed(function(){var t=r.value();return api.isEmpty(t)&&(t=e.value()),t}),e[n]=r}),e}(),i.opacity=ko.observable(),i.opacity.type(api.type.float,!0),i),m.visible=ko.computed(function(){return m.hasParent()?m.display()&&m.parent().visible():m.display()}),e.trigger("init",m,n,t),api.isObject(n.component)?m.element(new models.component(n.component)):api.isObject(n.widget)?m.element(new models.widget(n.widget)):api.isObject(n.block)?m.element(new models.block(n.block)):api.isObject(n.variator)?m.element(new models.variator(n.variator)):api.isObject(n.area)?m.element(new models.area(n.area)):api.each(n.containers,function(e,t){m.addContainer(new constructor.models.container(t))}),m.setProperties(n.properties),e.trigger("created",m,n,t)}).prototype.setParent=function(e){this.parent(e)},e.prototype.getParent=function(){return this.parent()},e.prototype.getParentType=function(){return e.is(this.parent())?this.getParent().type():null},e.prototype.hasParent=function(){return e.is(this.parent())||models.variant.is(this.parent())||models.area.is(this.parent())},e.prototype.getParents=function(){var e=[],t=function(n){var r;n.hasParent()&&(r=n.getParent(),e.push(r),t(r))};return t(this),e},e.prototype.remove=function(){return!!this.hasParent()&&(this.getParent().removeContainer(this),e.trigger("remove",this),!0)},e.prototype.copy=function(){return new e(this.save(!0))},e.prototype.save=function(t){var n;return n={},(t=api.toBoolean(t))||(n.id=this.id(),n.code=this.code()),n.type=this.type(),n.display=this.display(),n.order=this.order(),n.condition=this.condition.save(),n.script=this.script(),n.properties=this.getProperties(),n.area=null,n.component=null,n.widget=null,n.block=null,n.variator=null,n.containers=[],this.hasComponent()?n.component=this.getComponent().save(t):this.hasWidget()?n.widget=this.getWidget().save(t):this.hasBlock()?t||(n.block=this.getBlock().save()):this.hasVariator()?n.variator=this.getVariator().save(t):this.hasArea()?n.area=this.getArea().save(t):api.each(this.containers(),function(e,r){n.containers.push(r.save(t))}),e.trigger("save",this,n),n},e.prototype.setComponent=function(e){this.element(e)},e.prototype.getComponent=function(){return this.hasComponent()?this.element():null},e.prototype.hasComponent=function(e){return models.component.is(e)?this.element()===e:models.component.is(this.element())},e.prototype.hasEmptyComponent=function(){return!this.hasComponent()||api.isEmpty(this.getComponent().code())},e.prototype.setWidget=function(e){this.element(e)},e.prototype.getWidget=function(){return this.hasWidget()?this.element():null},e.prototype.hasWidget=function(e){return models.widget.is(e)?this.element()===e:models.widget.is(this.element())},e.prototype.setBlock=function(e){this.element(e)},e.prototype.getBlock=function(){return this.hasBlock()?this.element():null},e.prototype.hasBlock=function(e){return models.block.is(e)?this.element()===e:models.block.is(this.element())},e.prototype.setVariator=function(e){this.element(e)},e.prototype.getVariator=function(){return this.hasVariator()?this.element():null},e.prototype.hasVariator=function(e){return models.variator.is(e)?this.element()===e:models.variator.is(this.element())},e.prototype.setArea=function(e){this.element(e)},e.prototype.getArea=function(){return this.hasArea()?this.element():null},e.prototype.hasArea=function(e){return models.area.is(e)?this.element()===e:models.area.is(this.element())},e.prototype.setElement=function(e){this.element(e)},e.prototype.getElement=function(){return this.element()},e.prototype.hasElement=function(e){return api.isObject(e)?this.element()===e:api.isObject(this.element())},e.prototype.getContainers=function(e){if(!api.isFunction(e))return this.containers();var t=this,n=[];return api.each(t.containers(),function(r,o){!0===e.call(t,r,o)&&n.push(o)}),n},e.prototype.getContainer=function(e){if(api.isFunction(e)){var t=this,n=null;return api.each(t.containers(),function(r,o){if(!0===e.call(t,r,o))return n=o,!1}),n}},e.prototype.hasContainers=function(){return this.containers().length>0},e.prototype.hasContainer=function(e){return this.containers.indexOf(e)>=0},e.prototype.addContainer=function(t){return!(!e.is(t)||this.hasComponent()||!this.hasContainer(t)&&(this.containers.push(t),0))},e.prototype.removeContainer=function(t){return!(!e.is(t)||!this.hasContainer(t)||(this.containers.remove(t),0))},e.prototype.getProperties=function(){return constructor.utils.properties.build(this.properties)},e.prototype.setProperties=function(e){constructor.utils.properties.parse(e,this.properties)},e.prototype.layerUp=function(){this.hasParent()&&this.order(this.order()-1.5)},e.prototype.layerDown=function(){this.hasParent()&&this.order(this.order()+1.5)},e.prototype.getChildren=function(){var e=function(t){var n=[];return api.each(t.containers(),function(t,r){n.push(r),r.hasContainers()&&(n=n.concat(e(r)))}),n};return e(this)},e.prototype.level=function(){return this.hasParent()?this.getParent().level():0},e.is=function(t){return t instanceof e},api.extend(e,api.ext.events(constructor)),e}(),models.condition=function(){var e,t={parent:new system.models.locker,conditions:new system.models.locker};return(e=function(n){var r,o,i=this,a=n.type;api.extend(i,api.ext.events(i)),n=api.isObject(n)?n:{},e.trigger("create",i,n,t),i.type=ko.computed(function(){return a}),i.result=ko.observable(n.result),i.parent=(r=t.parent,(o=ko.observable(null)).subscribe(function(e){models.container.is(e)&&r.operation(function(){e.removeCondition(i)})},null,"beforeChange"),o.subscribe(function(e){models.container.is(e)&&r.operation(function(){e.addCondition(i)})}),o(n.parent||null),o),i.level=ko.computed(function(){return i.hasParent()?i.parent().level()+1:0}),"group"===a?(i.operator=ko.observable(n.operator),i.conditions=function(t){var n;return(n=ko.observableArray([])).subscribe(function(n){api.each(n,function(n,r){"added"===r.status&&e.is(r.value)&&t.operation(function(){r.value.setParent(i)}),"deleted"===r.status&&e.is(r.value)&&t.operation(function(){r.value.setParent(null)})})},null,"arrayChange"),n}(t.conditions),e.trigger("init",i,n,t),api.each(n.conditions,function(t,n){i.addCondition(new e(n))})):"path"!==a&&"match"!==a&&"expression"!==a&&"parameter.get"!==a&&"parameter.page"!==a&&"parameter.template"!==a&&"site"!==a||(i.value=ko.observable(n.value),"match"===a?i.match=ko.observable(n.match):"parameter.get"!==a&&"parameter.page"!==a&&"parameter.template"!==a||(i.key=ko.observable(n.key),"parameter.page"!==a&&"parameter.template"!==a||(i.logic=ko.observable(n.logic)))),e.trigger("created",i,n,t)}).prototype.remove=function(){if(!this.hasParent())return!1;var e=this.getParent();for(e.removeCondition(this);e.hasParent();)e=e.getParent();return e.trigger("updateConditions"),!0},e.prototype.setParent=function(e){this.parent(e)},e.prototype.getParent=function(){return this.parent()},e.prototype.hasParent=function(){return e.is(this.parent())},e.prototype.hasConditions=function(){return"group"===this.type()&&this.conditions().length>0},e.prototype.hasCondition=function(e){return this.hasConditions()&&this.conditions.indexOf(e)>=0},e.prototype.addCondition=function(t){return!("group"!==this.type()||!e.is(t)||!this.hasCondition(t)&&(this.conditions.push(t),this.trigger("add"),0))},e.prototype.removeCondition=function(t){return!("group"!==this.type()||!e.is(t)||!this.hasCondition(t)||(this.conditions.remove(t),0))},e.prototype.save=function(){var t={};return t.type=this.type(),t.result=this.result(),"group"===t.type?(t.operator=this.operator(),t.conditions=[],api.each(this.conditions(),function(e,n){t.conditions.push(n.save())})):"path"!==t.type&&"match"!==t.type&&"expression"!==t.type&&"parameter.get"!==t.type&&"parameter.page"!==t.type&&"parameter.template"!==t.type&&"site"!==t.type||(t.value=this.value(),"match"===t.type?t.match=this.match():"parameter.get"!==t.type&&"parameter.page"!==t.type&&"parameter.template"!==t.type||(t.key=this.key(),"parameter.page"!==t.type&&"parameter.template"!==t.type||(t.logic=this.logic()))),e.trigger("save",this,t),t},e.prototype.getConditionGroups=function(e,t){if("group"==this.type())return!api.isEmpty(e)&&api.isArray(e)||(e=[]),api.isEmpty(t)&&(t=-1),e.push({model:this,index:t}),api.each(this.conditions(),function(t,n){n.getConditionGroups(e,t)}),e},e.is=function(t){return t instanceof e},api.extend(e,api.ext.events(constructor)),e}(),models.component=function(){var e,t={parent:new system.models.locker};return(e=function(n){var r,o=this;n=api.isObject(n)?n:{},e.trigger("create",o,n),o.id=ko.observable(n.id),o.code=ko.observable(n.code),o.template=ko.observable(n.template),o.properties=n.properties||{},o.parent=((r=ko.observable(null)).subscribe(function(e){models.container.is(e)&&t.parent.operation(function(){e.setComponent(null)})},null,"beforeChange"),r.subscribe(function(e){models.container.is(e)&&t.parent.operation(function(){e.setComponent(o)})}),r),api.each(n.properties,function(e,t){o.properties[e]=t}),e.trigger("created",o,n)}).prototype.save=function(t){var n={};return(t=api.toBoolean(t))||(n.id=this.id()),n.code=this.code(),n.template=this.template(),n.properties=this.properties,e.trigger("save",this,n),n},e.prototype.setParent=function(e){this.parent(e)},e.prototype.getParent=function(){return this.parent()},e.prototype.hasParent=function(){return models.container.is(this.parent())},e.prototype.level=function(){return this.hasParent()?this.getParent().level():0},e.is=function(t){return t instanceof e},api.extend(e,api.ext.events(constructor)),e}(),models.widget=function(){var e,t=constructor.widgets,n={parent:new system.models.locker};return(e=function(r){var o,i=this;r=api.isObject(r)?r:{},e.trigger("create",i,r,n),i.id=ko.observable(r.id),i.model=ko.computed(function(){return t.get(r.code)}),i.template=ko.observable(null),i.properties=null,i.data=ko.observable(r.data),i.structure=ko.observable(null),i.rebuild=function(e){var t={};api.isObject(e)||(e=i.getProperties()),i.properties={},null!==i.model()&&(i.model().handle(t,i,i.data(),"properties"),null!==i.template()&&i.template().handle(t,i,i.data(),"properties")),i.setProperties(e),null!==i.model()&&(i.model().handle(t,i,i.data(),null),null!==i.template()&&i.template().handle(t,i,i.data(),null)),i.structure(t)},i.views={},i.views.template=ko.computed(function(){if(i.structure(),null!==i.template())return i.template().view()}),i.views.settings=ko.computed(function(){if(i.structure(),null!==i.template())return i.template().settings()}),i.parent=((o=ko.observable(null)).subscribe(function(e){models.container.is(e)&&n.parent.operation(function(){e.setWidget(null)})},null,"beforeChange"),o.subscribe(function(e){models.container.is(e)&&n.parent.operation(function(){e.setWidget(i)})}),o),null!==i.model()&&(i.template(i.model().templates.get(r.template)),null===i.template()&&i.template(i.model().templates.get(".default"))),e.trigger("created",i,r,n),i.rebuild(r.properties),i.template.subscribe(function(){i.rebuild()}),i.data.subscribe(function(){i.rebuild()})}).prototype.save=function(t){var n={};return(t=api.toBoolean(t))||(n.id=this.id()),n.code=null,n.template=null,n.properties=this.getProperties(),null!==this.model()&&(n.code=this.model().code(),null!==this.template()&&(n.template=this.template().code())),e.trigger("save",this,n),n},e.prototype.setParent=function(e){this.parent(e)},e.prototype.getParent=function(){return this.parent()},e.prototype.hasParent=function(){return models.container.is(this.parent())},e.prototype.setProperties=function(e){constructor.utils.properties.parse(e,this.properties)},e.prototype.getProperties=function(){return constructor.utils.properties.build(this.properties)},e.prototype.level=function(){return this.hasParent()?this.getParent().level():0},e.is=function(t){return t instanceof e},api.extend(e,api.ext.events(constructor)),e}(),models.block=function(){var e,t={parent:new system.models.locker};return(e=function(n){var r,o=this;n=api.isObject(n)?n:{},e.trigger("create",o,n),o.id=ko.observable(n.id),o.name=ko.observable(n.name),o.parent=((r=ko.observable(null)).subscribe(function(e){models.container.is(e)&&t.parent.operation(function(){e.setBlock(null)})},null,"beforeChange"),r.subscribe(function(e){models.container.is(e)&&t.parent.operation(function(){e.setBlock(o)})}),r),e.trigger("created",o,n)}).prototype.save=function(){var t={};return t.id=this.id(),t.name=this.name(),e.trigger("save",this,t),t},e.prototype.setParent=function(e){this.parent(e)},e.prototype.getParent=function(){return this.parent()},e.prototype.hasParent=function(){return models.container.is(this.parent())},e.prototype.level=function(){return this.hasParent()?this.getParent().level():0},e.is=function(t){return t instanceof e},api.extend(e,api.ext.events(constructor)),e}(),models.area=function(){var e,t={parent:new system.models.locker,container:new system.models.locker};return(e=function(n){var r,o,i=this;n=api.isObject(n)?n:{},e.trigger("create",i,n),i.id=ko.observable(n.id),i.name=ko.computed(function(){return n.name}),i.parent=(r=t.parent,(o=ko.observable(null)).subscribe(function(e){models.container.is(e)&&r.operation(function(){e.setArea(null)})},null,"beforeChange"),o.subscribe(function(e){models.container.is(e)&&r.operation(function(){e.setArea(i)})}),o),i.container=function(e){var t;return(t=ko.observable(null)).subscribe(function(t){models.container.is(t)&&e.operation(function(){t.setParent(null)})},null,"beforeChange"),t.subscribe(function(t){models.container.is(t)&&e.operation(function(){t.setParent(i)})}),t}(t.container),i.visible=ko.computed(function(){return!!i.hasParent()&&i.parent().visible()}),e.trigger("init",i,n),api.isObject(n.container)||(n.container={}),n.container.display=!0,i.container(new models.container(n.container)),e.trigger("created",i,n)}).prototype.save=function(t){var n;return n={},(t=api.toBoolean(t))||(n.id=this.id()),n.container=null,constructor.isContainer(this.container())&&(n.container=this.container().save(t)),e.trigger("save",this,n),n},e.prototype.setParent=function(e){this.parent(e)},e.prototype.getParent=function(){return this.parent()},e.prototype.hasParent=function(){return models.container.is(this.parent())},e.prototype.level=function(){return this.hasParent()?this.getParent().level():0},e.is=function(t){return t instanceof e},api.extend(e,api.ext.events(constructor)),e}(),models.variator=function(){var e,t={parent:new system.models.locker,variants:new system.models.locker};return(e=function(n){var r,o,i,a=this;n=api.isObject(n)?n:{},e.trigger("create",a,n),a.id=ko.observable(n.id),a.variant=ko.observable(n.variant),a.parent=((r=ko.observable(null)).subscribe(function(e){models.container.is(e)&&t.parent.operation(function(){e.setVariator(null)})},null,"beforeChange"),r.subscribe(function(e){models.container.is(e)&&t.parent.operation(function(){e.setVariator(a)})}),r),a.variants=(o=t.variants,(i=ko.observableArray([])).subscribe(function(e){api.each(e,function(e,t){"added"===t.status&&models.variant.is(t.value)&&o.operation(function(){t.value.setParent(a)}),"deleted"===t.status&&models.variant.is(t.value)&&o.operation(function(){t.value.setParent(null)})}),i.order()},null,"arrayChange"),i.order=function(){o.operation(function(){i.sort(function(e,t){return e.order()==t.order()?0:e.order()<t.order()?-1:1}),api.each(i(),function(e,t){t.order(e)}),i.valueHasMutated()})},i),e.trigger("init",a,n),api.each(n.variants,function(e,t){a.addVariant(new constructor.models.variant(t))}),e.trigger("created",a,n)}).prototype.save=function(t){var n;return n={},(t=api.toBoolean(t))||(n.id=this.id()),n.variant=this.variant(),n.variants=[],api.each(this.variants(),function(e,r){n.variants.push(r.save(t))}),e.trigger("save",this,n),n},e.prototype.setParent=function(e){this.parent(e)},e.prototype.getParent=function(){return this.parent()},e.prototype.hasParent=function(){return models.container.is(this.parent())},e.prototype.getVariants=function(e){if(!api.isFunction(e))return this.variants();var t=this,n=[];return api.each(t.variants(),function(r,o){!0===e.call(t,r,o)&&n.push(o)}),n},e.prototype.getVariant=function(e){var t=this.getVariants();return api.isInteger(e)||(e=this.variant()+1),e<0?null:e>t.length?null:t[e-1]},e.prototype.hasVariants=function(){return this.variants().length>0},e.prototype.hasVariant=function(e){return this.variants.indexOf(e)>=0},e.prototype.addVariant=function(e){return!(!models.variant.is(e)||!this.hasVariant(e)&&(this.variants.push(e),0))},e.prototype.removeVariant=function(e){return!(!models.variant.is(e)||!this.hasVariant(e)||(this.variants.remove(e),0))},e.prototype.level=function(){return this.hasParent()?this.getParent().level():0},e.is=function(t){return t instanceof e},api.extend(e,api.ext.events(constructor)),e}(),models.variant=function(e){var t,n={parent:new system.models.locker,container:new system.models.locker};return(t=function(e){var r,o,i,a=this;e=api.isObject(e)?e:{},t.trigger("create",a,e),a.id=ko.observable(e.id),a.code=ko.observable(e.code),a.order=ko.observable(e.order),a.order.subscribe(function(){a.hasParent()&&a.getParent().variants.order()}),a.name=ko.observable(e.name),a.parent=((r=ko.observable(null)).subscribe(function(e){models.variator.is(e)&&n.parent.operation(function(){e.removeVariant(a)})},null,"beforeChange"),r.subscribe(function(e){models.variator.is(e)&&n.parent.operation(function(){e.addVariant(a)})}),r),a.container=(o=n.container,(i=ko.observable(null)).subscribe(function(e){models.container.is(e)&&o.operation(function(){e.setParent(null)})},null,"beforeChange"),i.subscribe(function(e){models.container.is(e)&&o.operation(function(){e.setParent(a)})}),i),a.visible=ko.computed(function(){var e;return!!a.hasParent()&&!!(e=a.parent()).hasParent()&&e.getVariant()===a&&e.parent().visible()}),t.trigger("init",a,e),api.isObject(e.container)||(e.container={}),e.container.display=!0,a.container(new models.container(e.container)),t.trigger("created",a,e)}).prototype.save=function(e){var n;return n={},(e=api.toBoolean(e))||(n.id=this.id(),n.code=this.code()),n.order=this.order(),n.name=this.name(),n.container=null,constructor.isContainer(this.container())&&(n.container=this.container().save(e)),t.trigger("save",this,n),n},t.prototype.remove=function(){return!!this.hasParent()&&(this.getParent().removeVariant(this),t.trigger("remove",this),!0)},t.prototype.setParent=function(e){this.parent(e)},t.prototype.getParent=function(){return this.parent()},t.prototype.hasParent=function(){return models.variator.is(this.parent())},t.prototype.selected=function(){return!!this.hasParent()&&this.getParent().getVariant()===this},t.prototype.select=function(){var e;this.hasParent()&&(e=this.getParent()).variant(e.variants.indexOf(this))},t.prototype.level=function(){return this.hasParent()?this.getParent().level():0},t.is=function(e){return e instanceof t},api.extend(t,api.ext.events(constructor)),t}(),models),constructor.isArea=function(e){return constructor.models.area.is(e)},constructor.isContainer=function(e){return constructor.models.container.is(e)},constructor.isCondition=function(e){return constructor.models.condition.is(e)},constructor.isComponent=function(e){return constructor.models.component.is(e)},constructor.isWidget=function(e){return constructor.models.widget.is(e)},constructor.isBlock=function(e){return constructor.models.block.is(e)},constructor.isVariator=function(e){return constructor.models.variator.is(e)},constructor.isVariant=function(e){return constructor.models.variant.is(e)},constructor.isPropertyMeasured=function(e){return constructor.models.property.measured.is(e)},constructor.isPropertyCustom=function(e){return constructor.models.property.custom.is(e)},api.extend(constructor,api.ext.events(constructor)),constructor}}(intec);